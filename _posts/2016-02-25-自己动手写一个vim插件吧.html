<html server-rendered="true"><head><meta charset="UTF-8"> <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width,user-scalable=no"> <meta name="renderer" content="webkit"> <meta name="theme-color" content="#ffffff"> <link href="/css/build.HomePage.css" rel="stylesheet"> <link href="/css/build.PostPage.css" rel="stylesheet"> <title> Minghe </title></head><section class="post-view"><h1 class="post-title">
    自己动手写一个vim插件吧
    <time pubdate="pubdate" class="post-date"></time></h1> <article><p>每一个程序员都应该有洁癖, 这个洁癖应该包括两个方面:<br>一是代码书写的整洁，二是代码逻辑的清晰简洁。第二点需要我们不断的学习，大量的阅读思考，日积月累才能做到，因为逻辑的清晰，需要我们的良好的算法设计，结构优化，性能调优等等，只有长期的知识积累才能做到。然后代码书写的整洁却是我们可以随时做到，而且各种各样的<br>IDE<br>也都有着良好的美化功能。所以整洁的代码书写如果我们不想自己动手去整理，我们大可以让我们的工具帮我们来完成。</p>
<p>vim一直是我的主打编辑器，尝试了其他很多编辑器之后，我还是回到了vim。有了<br><a href="https://github.com/VundleVim/Vundle.vim">vundle</a>,<br>vim实在是太方便了，无数优良的插件，让我们的vim几乎可以完成我们日常中所有需求。来到了 <a href="secondspectrum.com">secondspectrum</a><br>之后，我的每一段代码至少都会被一位同事 review,<br>所以良好的代码风格，整洁的代码书写真的关乎颜面啊，所有前天我同事和我说，我的代码里面有很很多句尾空格，能不能去掉。我大惊.<br><code> :set list </code><br>一看，果然好多句尾空格，想了一下，总不能不同敲击 <code>:%s/\s+$//g</code> 来去掉这烦人的东西吧，还是google看看有没有可以用的插件吧，搜了一圈，没有看到合适的(莫非我姿势不对?)。</p>
<p>好吧，那就自己来做一个吧。</p>
<h3 id="开始动手吧">开始动手吧</h3><p>我们知道写vim的插件使用<br><a href="https://en.wikipedia.org/wiki/Vim_(text_editor">vimL</a>&#35;Vim_script), 当然现在我们也可以使用 Ruby, Python 等来编写 vim 插件，不过 vimL 其实也不难，简单看看就可以使用了。</p>
<ul>
<li><p>构建Pathogen/Vundle/NeoBundle/Plug/VAM-compatible 的插件项目结构</p>
<p>  初始化你的插件目录如下:</p>
</li>
</ul>
<pre><code class="lang-undefined">
<span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>vim<span class="token regex">/autoload/</span><span class="token operator">...</span>
      <span class="token regex">/doc/</span><span class="token operator">...</span>
      <span class="token regex">/autoload/</span><span class="token operator">...</span>
      <span class="token regex">/ftplugin/</span><span class="token operator">...</span>
      <span class="token regex">/indent/</span><span class="token operator">...</span>
      <span class="token regex">/plugin/</span><span class="token operator">...</span>
      <span class="token regex">/syntax/</span><span class="token operator">...</span>
      <span class="token operator">/</span><span class="token operator">...</span></code></pre><p>让我们来简单了解一下各个目录和文件都有什么用吧。</p>
<ol>
<li>autoload<br>vim 插件和常规使用的一些 functions</li>
<li>doc<br>文档</li>
<li>ftplugin<br>使用于指定文件类型的vim插件脚本, 这里面所有以<code> .vim </code> 结尾的文件在检测到文件类型之后，如果文件名匹配都会被 <code> source </code>.</li>
<li>indent<br>针对指定文件类型的缩紧设置</li>
<li>plugin<br>标准的vim插件, 这里所有以 <code> .vim </code> 结尾的文件在 vim 启动的时候都会被 <code> source </code></li>
<li>syntax<br>这里放置的是语法高亮设置。</li>
</ol>
<p>有了这些基本了解之后，我们就可以开始动手了</p>
<ul>
<li>编写插件代码</li>
</ul>
<p>给我的插件命名为 ’trims&#39; 吧，简单但是不明了。</p>
<pre><code class="lang-undefined">  $ mkdir trims
  $ cd trims
  $ mkdir doc plugin
  $ echo <span class="token string">"a simple vim plugin to remove space in the end of line"</span> <span class="token operator">></span> README</code></pre><p>我们的插件只要这么简单的结构就可以了。</p>
<pre><code class="lang-undefined">  $ vim plugin<span class="token operator">/</span>trims<span class="token punctuation">.</span>vim</code></pre><p>内容添加如下:</p>
<pre><code class="lang-undefined">fun<span class="token operator">!</span> <span class="token function">TrimWhitespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> l<span class="token punctuation">:</span>save_cursor <span class="token operator">=</span> <span class="token function">getpos</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
  <span class="token operator">%</span>s<span class="token operator">/</span>\s\<span class="token operator">+</span>$<span class="token comment" spellcheck="true">//e</span>
  call <span class="token function">setpos</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> l<span class="token punctuation">:</span>save_cursor<span class="token punctuation">)</span>
endfun

" trim end <span class="token keyword">of</span> line space hook
autocmd BufWritePre <span class="token operator">&lt;</span>buffer<span class="token operator">></span> call <span class="token function">TrimWhitespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这样我们就完成了我们的插件书写，内容很简单，对吧。一个函数 <code> TrimWhitespace() </code>, 使用正则替换掉句尾的空格，然后在我们保持我们的文件 <code>:w</code>, 就调用我们的函数。</p>
<ul>
<li>测试我们的插件</li>
</ul>
<p>我们可以很简单的测试我们插件，我们可以在我们的 <code> ~/.vimrc </code> 添加 <code> source /path/to/trims.vim</code>, 或者我们把我们整个 trims 目录copy到我们的插件目录下。然后随意编辑一个文件，然后保存即可看到效果。</p>
<ul>
<li>发布我们的插件</li>
</ul>
<p>写好插件，我们当然希望可以帮助到其他人喽，如何让我们以及其他人可以简单的使用我们的插件呢，vundle 当然是最方便的啦。</p>
<ol>
<li><p>push 插件到 <a href="https://github.com">GitHub</a></p>
<p>先到  <a href="https://github.com">GitHub</a> 上开一个 repo，比如我们就叫做 &quot;trims&quot;, 然后push我们的插件到repo上。</p>
</li>
</ol>
<pre><code class="lang-undefined">  $ cd trims
  $ git init

  $ git remote add origin https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>metrue<span class="token operator">/</span>trims<span class="token punctuation">.</span>git
  $ git push <span class="token operator">-</span>u origin master</code></pre><ol>
<li>配置 .vimrc 按照并且使用我们的插件</li>
</ol>
<p>首先，当然要先确保你已经安装并且配置好了<br><a href="https://github.com/VundleVim/Vundle.vim">vundle</a>, 然后在你的 <code> ~/.vimrc </code> 中添加</p>
<pre><code class="lang-undefined">  Plugin <span class="token string">'metrue/trims'</span></code></pre><p>然后运行 vim, 运行 <code> :BundleInstall </code>. 安装完毕之后，你的vim就可以使用我们自己写的去掉句尾空格的插件了.</p>
<h3 id="结尾">结尾</h3><p>本文demo的插件地址:<br><a href="https://github.com/metrue/trims">https://github.com/metrue/trims</a></p>
</article></section><footer class="footer">
  Copyright ©2014-2017 <a href="http://minghe.me"> minghe.me</a> | Powered by <a href="https://github.com/metrue/Seal">Seal</a> on top of <a href="https://vuejs.org" target="_blank">Vue.js</a></footer></html>