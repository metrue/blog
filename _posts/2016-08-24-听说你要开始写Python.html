<html server-rendered="true"><head><meta charset="UTF-8"> <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width,user-scalable=no"> <meta name="renderer" content="webkit"> <meta name="theme-color" content="#ffffff"> <link href="/css/build.HomePage.css" rel="stylesheet"> <link href="/css/build.PostPage.css" rel="stylesheet"> <title> Minghe </title></head><section class="post-view"><h1 class="post-title">
    听说你要开始写Python
    <time pubdate="pubdate" class="post-date"></time></h1> <article><p>听说你准备写 Python, 在你开始真正的 Python 生涯之前，你可以先问问你下面三个问题:</p>
<ul>
<li>你确定你要写 Python 吗</li>
<li>你确定你要写 Python 吗</li>
<li>你确定你要写 Python 吗</li>
</ul>
<p>如果你答案中有一点迟疑，那么请你出门左拐到隔壁的 Ruby，或者右拐到隔壁的 Node，或者笔直的往前走, 看看 Go, 也不满意的话，绕过旁边的 PHP, 走回老家，开始玩玩 Perl, 也是极好的。</p>
<p>当然如果你的答案是三个大大的 YES, ( 因为我靠写 Python 为生, 笔者就是这样的 ), 那么和我一起准备好成吨的痛苦的眼泪开始我们的第一个 Python 项目，通过这个简单的项目，也许我们能够开心的码 Python 代码了.</p>
<h3 id="基础环境">基础环境</h3><ul>
<li>Python 版本管理</li>
</ul>
<p>和其他很多动态语言一样，多版本管理是天然需求了，Ruby 有 rvm, Node 有 nvm, 用脚趾头可能会猜 Python 的版本可能就是 pvm, 还真是不是，它叫 pyenv, 基本上和 rvm 和 nvm 差不多，你掌握下面这些知识，就可以安全的让你度过你 Python 生涯的第一阶段了</p>
<pre><code class="lang-undefined">brew install pyenv      # 安装
pyenv install <span class="token operator">--</span>list    # 看看可以安装那些包
pyenv install <span class="token number">2.7</span><span class="token punctuation">.</span><span class="token number">12</span>    # 安装 python <span class="token number">2.7</span><span class="token punctuation">.</span><span class="token number">12</span>
pyenv install <span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">2</span>     # 安装 python <span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">2</span>
pyenv local <span class="token number">2.7</span><span class="token punctuation">.</span><span class="token number">12</span>      # 设置当前目录使用版本 <span class="token number">2.7</span><span class="token punctuation">.</span><span class="token number">12</span> 的 Python
pyenv global <span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">2</span>      # 设置当前目录使用版本 <span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">2</span> 的 Python
pyenv version           # 显示当前所使用的 Python</code></pre><ul>
<li>Python 包管理</li>
</ul>
<p>如果你之前是使用 Homebrew 安装了 Python，那么包管理工具 pip 应该已经安装好了，也可以这样安装 pip.</p>
<pre><code class="lang-undefined">curl https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>bootstrap<span class="token punctuation">.</span>pypa<span class="token punctuation">.</span>io<span class="token operator">/</span>ez_setup<span class="token punctuation">.</span>py <span class="token operator">-</span>o <span class="token operator">-</span> <span class="token operator">|</span> sudo python
easy_install pip</code></pre><ul>
<li>包版本管理</li>
</ul>
<p>不像 Node 的 npm，npm 可以安装依赖到当前项目本地，不会产生和系统全局依赖版本冲突的问题, 而 Python 的 pip 是会检查系统是否已经存在了相关包，然后才会决定是否安装，而且是安装到全局目录上。为了解决这个问题, Python 社区出现了 virtualenv 这个工具，你可以这么使用它..</p>
<pre><code class="lang-undefined">pip install virtualenv    # 安装virtualenv
virtualenv ENV            # 在当前项目中使用 virtualenv
source <span class="token punctuation">.</span><span class="token operator">/</span>ENV<span class="token operator">/</span>bin<span class="token operator">/</span>active   # 让它生效</code></pre><p>这样你就可以在当前目录中安装任何合适版本的依赖包了。</p>
<h3 id="开始写项目">开始写项目</h3><ul>
<li>package 和 module</li>
</ul>
<p>在开始写代码之前，Python 有两个概念你需要去了解一下, package 和 module. 在 Python 中，任何以 .py 结尾的文件都是一个 module, 而 package 则是那些则是 modules 的集合, 那些包含 <code> <strong>init</strong>.py </code> 的目录都是一个 package，package 下面可以有 subpackage.</p>
<pre><code class="lang-undefined">a
├── __init__<span class="token punctuation">.</span>py
├── a<span class="token punctuation">.</span>py
└── b
    ├── __init__<span class="token punctuation">.</span>py
    ├── b<span class="token punctuation">.</span>py
    └── c
        ├── __init__<span class="token punctuation">.</span>py
        └── c<span class="token punctuation">.</span>py</code></pre><p>上面这样的目录结构可以知道 package a 下面有 subpackge b, 而 package b 下面又有 subpackage c，我们可以这样去使用这些 packages</p>
<pre><code class="lang-undefined"><span class="token keyword">import</span> a
<span class="token keyword">from</span> a <span class="token keyword">import</span> a
<span class="token keyword">from</span> a<span class="token punctuation">.</span>b <span class="token keyword">import</span> b
<span class="token keyword">from</span> a<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c <span class="token keyword">import</span> c</code></pre><p>当然更好的做法是在 <strong>init</strong>.py 中去定义我们需要 export 出来的 module, 比如我们可以:</p>
<pre><code class="lang-undefined"><span class="token keyword">from</span> a <span class="token keyword">import</span> a_say_hello
<span class="token keyword">from</span> b <span class="token keyword">import</span> b_say_hello
__all__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a_say_hello'</span><span class="token punctuation">,</span> <span class="token string">'b_say_hello'</span><span class="token punctuation">]</span></code></pre><p>然后你就可以这样去 import 需要的东西了</p>
<pre><code class="lang-undefined">  <span class="token keyword">from</span> a <span class="token keyword">import</span> a_say_hello<span class="token punctuation">,</span> b_say_hello</code></pre><ul>
<li>项目目录结构</li>
</ul>
<p>无论你的项目是一个 Application 还是一个 Library, 都可以遵循下面的项目结构</p>
<pre><code class="lang-undefined"><span class="token punctuation">.</span>
├── README<span class="token punctuation">.</span>md
├── bin
│   └── <span class="token operator">&lt;</span>app<span class="token operator">></span>
├── <span class="token operator">&lt;</span>package_name<span class="token operator">></span> <span class="token operator">/</span> <span class="token operator">&lt;</span>app_name<span class="token operator">></span>
│   ├── __init__<span class="token punctuation">.</span>py
├── setup<span class="token punctuation">.</span>py
└── tests
    ├──  test_a<span class="token punctuation">.</span>py
    ├──  test_b<span class="token punctuation">.</span>py</code></pre><p>当然，一个简单的 README.md 是必不可少了，如果你需要发布的一个 Application, bin 目录下就是你的 Application 的可执行文件，也就是用户 pip install <your package> 之后可以直接运行的。而 <package_name> 目录下则是你的源代码目录，这下面你可以安装你的逻辑需求分拆成你需要的各种子目录，形成子模块。正如前面所说，你可以通过 <strong>init</strong>.py 来灵活的控制你的代码间依赖可见性。 tests 目录就是你的测试目录，测试是一种信仰，如果一个项目连测试都没有，怎么看出它是一个靠谱的项目呢。setup.py 则是项目的核心管理入口，相当 Node 项目的 package.json. 正确写好 setup.py 才能让我们的 Python 项目顺利的事半功倍完美开始。</p>
<ul>
<li>setup.py 入门</li>
</ul>
<p>其实不是 setup.py 入门，而是 setuptools 入门，通过 setuptools，我们才能愉快的做下面的事情:</p>
<ol>
<li>定义要发布的包和模块</li>
<li>运行测试</li>
<li>项目安装</li>
<li>平台相关的信息定义</li>
<li>支持 Python 3</li>
</ol>
<p>首先当然需要安装一下 setuptools 这个库，如果你之前已经使用 ez_setu.py 了这个工具，那么 setuptools 这个库就已经安装好了。当然你可以像安装其他库一样安装 setuptools 就好了, 那么让我们来看看一个基础使用的 setup.py 大致是什么样的吧。</p>
<pre><code class="lang-undefined"><span class="token keyword">from</span> setuptools <span class="token keyword">import</span> setup<span class="token punctuation">,</span> find_packages<span class="token punctuation">,</span> Command
<span class="token keyword">import</span> unittest<span class="token punctuation">,</span> os

<span class="token keyword">class</span> <span class="token class-name">CleanCommand</span><span class="token punctuation">(</span>Command<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span><span class="token string">"Custom clean command to tidy up the project root."</span><span class="token string">""</span>
    user_options <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    def <span class="token function">initialize_options</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pass
    def <span class="token function">finalize_options</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pass
    def <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'rm -vrf ./build ./dist ./*.pyc ./*.tgz ./*.egg-info'</span><span class="token punctuation">)</span>

def <span class="token function">test_suite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    test_loader <span class="token operator">=</span> unittest<span class="token punctuation">.</span><span class="token function">TestLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    test_suite <span class="token operator">=</span> test_loader<span class="token punctuation">.</span><span class="token function">discover</span><span class="token punctuation">(</span><span class="token string">'tests'</span><span class="token punctuation">,</span> pattern<span class="token operator">=</span><span class="token string">'test_*.py'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> test_suite

<span class="token function">setup</span><span class="token punctuation">(</span>
    name <span class="token operator">=</span> <span class="token string">'package-cleaner'</span><span class="token punctuation">,</span>
    version <span class="token operator">=</span> <span class="token string">'0.0.5'</span><span class="token punctuation">,</span>
    description <span class="token operator">=</span> <span class="token string">'A artifactory packages cleaner'</span><span class="token punctuation">,</span>
    packages <span class="token operator">=</span> <span class="token function">find_packages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_suite <span class="token operator">=</span> <span class="token string">'setup.test_suite'</span><span class="token punctuation">,</span>
    scripts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'bin/clean_package'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    author <span class="token operator">=</span> <span class="token string">'Minghe Huang'</span><span class="token punctuation">,</span>
    author_email <span class="token operator">=</span> <span class="token string">'h.minghe@gmail.com'</span><span class="token punctuation">,</span>
    install_requires <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'requests'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    url <span class="token operator">=</span> <span class="token string">'http://&lt;project home page>'</span><span class="token punctuation">,</span>

    cmdclass <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'clean'</span><span class="token punctuation">:</span> CleanCommand<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre><p>这个简单的 setup.py 不仅设置我们项目的基本信息，名字，版本，描述等，而且还定义了我们的项目依赖, 当然，你还可以看到我们拓展了一个命令: clean, 这样我们就可以很容易的清理掉 build 出来的中间文件了。有了这些定义之后，我们就可以轻易的做下面的事情了.</p>
<pre><code class="lang-undefined">python setup<span class="token punctuation">.</span>py install       # 安装项目
python setup<span class="token punctuation">.</span>py build         # build项目，为发布做准备
python setup<span class="token punctuation">.</span>py test          # 跑测试
python setup<span class="token punctuation">.</span>py sdist upload  # 发布你的项目</code></pre><ul>
<li>如何写测试</li>
</ul>
<p>你可以使用 Pytest 来写测试，当然使用 Python 自带的 unittest 也基本上满足要求，看一个简单的例子，你就基本上知道怎么写测试了。</p>
<pre><code class="lang-undefined"><span class="token keyword">import</span> unittest

<span class="token keyword">from</span> package_cleaner <span class="token keyword">import</span> PackageCleaner

<span class="token keyword">class</span> <span class="token class-name">TestPackageCleaner</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    def <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token string">'https://repo.xxxx.com/artifactory'</span>
        self<span class="token punctuation">.</span>cleaner <span class="token operator">=</span> <span class="token function">PackageCleaner</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>server<span class="token punctuation">)</span>

    def <span class="token function">test_clean</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        path <span class="token operator">=</span> <span class="token string">'https://repo.xxxx.com/artifactory/api/storage/Solutions'</span>
        cleanable<span class="token punctuation">,</span> reason <span class="token operator">=</span> self<span class="token punctuation">.</span>cleaner<span class="token punctuation">.</span><span class="token function">is_cleanable</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>cleanable<span class="token punctuation">,</span> False<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>reason<span class="token punctuation">,</span> <span class="token string">'not consider develop branch'</span><span class="token punctuation">)</span>

    @unittest<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token string">'not safe yet'</span><span class="token punctuation">)</span>
    def <span class="token function">test_romove</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token string">""</span>"
      blahbal
      <span class="token string">""</span>"

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    unittest<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>unittest 提供一些基本的断言函数，通过这些基本的断言函数，基本上可以构造任意的断言了，可以通过 .skip 来略过一些 testcase, 当然还有其他的进阶功能，比如 testcase group 啊就不再多说了，文档很是齐全。</p>
<h3 id="最后">最后</h3><p>至此，你基本可以稍微轻松的写 Python 代码了，赶紧好好写一个牛逼的项目，让大家玩玩吧.</p>
</article></section><footer class="footer">
  Copyright ©2014-2017 <a href="http://minghe.me"> minghe.me</a> | Powered by <a href="https://github.com/metrue/Seal">Seal</a> on top of <a href="https://vuejs.org" target="_blank">Vue.js</a></footer></html>