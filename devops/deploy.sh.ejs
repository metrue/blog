#!/bin/bash

target='<%= user %>@<%= host %>'
ssh ${target} <<END
  docker rmi \$(docker images --filter "dangling=true" -q --no-trunc)
  rm -rf /tmp/<%= domain %>
  git clone <%= repo %> /tmp/<%= domain %>
  cd /tmp/minghe.me

  docker rm \$(docker stop \$(docker ps -a -q --filter ancestor=seal  --format="{{.ID}}"))

  docker run --rm -p 80:80 -p 443:443 \
    -v /etc/letsencrypt:/etc/letsencrypt \
    quay.io/letsencrypt/letsencrypt auth \
    --standalone -m <%= email %> --agree-tos \
    -d <%= domain %>

    docker run --rm -p 80:80 -p 443:443 \
      -v /etc/letsencrypt:/etc/letsencrypt \
      quay.io/letsencrypt/letsencrypt renew \
      --standalone

  docker build -f devops/dockerfile.nginx -t seal .
  docker run -d -p 80:80 -p 443:443 -v /etc/letsencrypt:/etc/letsencrypt seal
END
