<html server-rendered="true"><head><meta charset="UTF-8"> <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width,user-scalable=no"> <meta name="renderer" content="webkit"> <meta name="theme-color" content="#ffffff"> <link href="/css/build.HomePage.css" rel="stylesheet"> <link href="/css/build.PostPage.css" rel="stylesheet"> <title> Minghe </title></head><section class="post-view"><h1 class="post-title">
    在Rails之外使用ActiveRecord
    <time pubdate="pubdate" class="post-date"></time></h1> <article><p>ActiveRecord做为Rails的核心组件，也是最优秀的ORM框架之一，Ruby社区的好东西真是多啊，而每一样都 够我研究好一阵子。这就是Ruby最好玩的地方。当第一次使用Rails的时候，我就一直想着如何构建一个自己类Rails框架呢，就当着一个练习也是好，只有这样才能真正的理解Rails的美。 Rails作为漂亮的MVC框架，它也是由很多组件来构建出来的。而ActiveRecord则是MVC中M（Model）的支撑组件。它屏蔽了繁复的数据库操作，将它们都映射成类的方法，每一个类对应着数据库中的表，而类的每一个实例这是对应着表的一行，而且实例的属性则是表的每一列。</p>
<p>为了在Rails之外使用ActiverRecord，我们首先要</p>
<pre><code class="lang-undefined">$ gem install activerecord</code></pre><p>我想用我最近写的一个小工具来简单说说ActiveRecord的用法,简单介绍一下我的小工具：由于我们部门是软件工程部，负责着公司大多数产品的开发，测试，发布等等，没有运行的任务成百上千，所使用的工具也很多，定制的脚本更是不计其数，但是我发现这些程序的运行没有一个很好的反馈机制，结果的分布是零散的，这样所导致的结果是我们每天下班之前对于这些job的运行状况不好收集，不能够很好的向美国的同事进行交接。 所以我要实现的是一个集中的任务状态管理系统，我首先把这个需求简化成:我只需要一个任务的回报中心，每一个运行的程序隔一段时间可以向这个任务管理服务器进行回报，服务事实将这些程序的运行状态进行更新，现实在web页面上，我们可以良好的进行监控。</p>
<p>那么我们就可以把模型定义为：每一个账户有很多的任务。所以我们需要两张表：user 和 task, 对应到Ruby，也就是我们需要两个类: User 和 Task, 它们的关系是</p>
<pre><code class="lang-undefined"><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> ActiveRecord
    has_many <span class="token punctuation">:</span>tasks
end

<span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token operator">&lt;</span> ActiveRecord
    belongs_to <span class="token punctuation">:</span>user
end</code></pre><p>也许你已经注意到了，我们继承了ActivRecord这个类，而其中的 has_many 和 belongs_to 都是类方法，和attr_reader, attr_writer 类似。这样ActiveRecord就一定自动帮你帮User和Task数据库中的表，而属性则和数据库中的列进行了映射. 当然我们要建立一个数据库。</p>
<pre><code class="lang-undefined">  def connect_db
    activerecord<span class="token punctuation">:</span><span class="token punctuation">:</span>base<span class="token punctuation">.</span><span class="token function">establish_connection</span><span class="token punctuation">(</span><span class="token punctuation">:</span>adapter <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"sqlite3"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>database <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"test.db"</span><span class="token punctuation">)</span>
  end

  # <span class="token operator">++</span>
  # creat table <span class="token keyword">in</span> database
  # <span class="token operator">++</span>
  def setup_user_table
    activerecord<span class="token punctuation">:</span><span class="token punctuation">:</span>schema<span class="token punctuation">.</span>define <span class="token keyword">do</span>
      drop_table <span class="token punctuation">:</span>users <span class="token keyword">if</span> table_exists<span class="token operator">?</span> <span class="token punctuation">:</span>users
      create_table <span class="token punctuation">:</span>users <span class="token keyword">do</span> <span class="token operator">|</span>table<span class="token operator">|</span>
        table<span class="token punctuation">.</span>column <span class="token punctuation">:</span>name<span class="token punctuation">,</span> <span class="token punctuation">:</span>string
        table<span class="token punctuation">.</span>column <span class="token punctuation">:</span>email<span class="token punctuation">,</span> <span class="token punctuation">:</span>string
      end
    end
  end

  def setup_task_table
    activerecord<span class="token punctuation">:</span><span class="token punctuation">:</span>schema<span class="token punctuation">.</span>define <span class="token keyword">do</span>
      drop_table <span class="token punctuation">:</span>tasks <span class="token keyword">if</span> table_exists<span class="token operator">?</span> <span class="token punctuation">:</span>tasks
      create_table <span class="token punctuation">:</span>tasks <span class="token keyword">do</span> <span class="token operator">|</span>table<span class="token operator">|</span>
        table<span class="token punctuation">.</span>column <span class="token punctuation">:</span>user_id<span class="token punctuation">,</span> <span class="token punctuation">:</span>integer
        table<span class="token punctuation">.</span>column <span class="token punctuation">:</span>name<span class="token punctuation">,</span> <span class="token punctuation">:</span>string
        table<span class="token punctuation">.</span>column <span class="token punctuation">:</span>status<span class="token punctuation">,</span> <span class="token punctuation">:</span>string
      end
    end
  end</code></pre><p>这里我们采用的sqlite3作为数据库，建立两张表，User拥有名字和email两个属性，而Task则拥有所属的user，名字，状态三个属性。通过这三个方法，我们就快速的建立两个表，而之前的两个类则自动已经和这两个表映射。以后对于数据库的任何操作都可以通过类的来进行。</p>
</article></section><footer class="footer">
  Copyright ©2014-2017 <a href="http://minghe.me"> minghe.me</a> | Powered by <a href="https://github.com/***REMOVED***/Seal">Seal</a> on top of <a href="https://vuejs.org" target="_blank">Vue.js</a></footer></html>