<html server-rendered="true"><head><meta charset="UTF-8"> <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width,user-scalable=no"> <meta name="renderer" content="webkit"> <meta name="theme-color" content="#ffffff"> <link href="/css/build.HomePage.css" rel="stylesheet"> <link href="/css/build.PostPage.css" rel="stylesheet"> <title> Minghe </title></head><section class="post-view"><h1 class="post-title">
    React项目中使用dagre-d3
    <time pubdate="pubdate" class="post-date"></time></h1> <article><p>React 已经成为了公司所有项目的前端必选框架了, JavaScript 社区非常活跃，而 React 也几乎成为了前端最火热的框架，所以各种知名的库几乎都已经有了 React 的版本，比如 d3, 也有了了 <a href="https://github.com/esbullington/react-d3">react-d3</a>, 但是很可惜的是，还没有完全移植完成，还只能支持基本的几种形式，当然对于基础的 Web 应用也够用。可以偏偏有向无回路图 (Directed Acylic Graph) 还没有，那怎么办呢，同事说 <a href="https://github.com/apache/incubator-airflow">airflow</a> 使用了 <a href="https://github.com/cpettitt/dagre-d3">dagre-d3</a>，看了一下，使用起来很简单，效果也还不错，要不试试在 React 中试试吧。</p>
<p>其实要在 React 项目中使用 dagre-d3 只需要这几步就够了.</p>
<ul>
<li>先绘制几个点</li>
</ul>
<pre><code class="lang-undefined">  <span class="token keyword">const</span> dagGraph <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">dagreD3<span class="token punctuation">.</span>graphlib<span class="token punctuation">.</span>Graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    dagGraph<span class="token punctuation">.</span><span class="token function">setNode</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span> label<span class="token punctuation">:</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dagGraph<span class="token punctuation">.</span><span class="token function">setEdge</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul>
<li>获取你的 DOM node</li>
</ul>
<pre><code class="lang-undefined">  <span class="token keyword">const</span> svgDOMNode <span class="token operator">=</span> ReactDOM<span class="token punctuation">.</span><span class="token function">findDOMNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>svg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> svg <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>svgDOMNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> inner <span class="token operator">=</span> svg<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们的图当然要绘制在 <svg> 上，但是为什么需要在 <g> 里面呢，后面你就知道奇妙之处了。</p>
<ul>
<li>render 到你的 DOM 上吧</li>
</ul>
<pre><code class="lang-undefined">  <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">dagreD3<span class="token punctuation">.</span>render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span>inner<span class="token punctuation">,</span> dagGraph<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>由于有获取你真正的 DOM 节点，所以你需要将上面代码的执行放到 componentDidMount之后, 并且你应该这样。</p>
<pre><code class="lang-undefined"> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// your above codes</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code></pre><p>是不是看到你优美的 DAG 图了呀，可以怎么不能缩放呢，好吧，然我们来给我的 DAG 加上 zoom 支持吧。</p>
<ul>
<li>zoom 支持</li>
</ul>
<pre><code class="lang-undefined">  <span class="token keyword">const</span> zoom <span class="token operator">=</span> d3<span class="token punctuation">.</span>behavior<span class="token punctuation">.</span><span class="token function">zoom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'zoom'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">autoLayoutDag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> translateFunc <span class="token operator">=</span> <span class="token template-string"><span class="token string">`translate(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>d3<span class="token punctuation">.</span>event<span class="token punctuation">.</span>translate<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> scaleFunc <span class="token operator">=</span> <span class="token template-string"><span class="token string">`scale(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>d3<span class="token punctuation">.</span>event<span class="token punctuation">.</span>scale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">;</span>
    inner<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'transform'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>translateFunc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scaleFunc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  svg<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>zoom<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">dagreD3<span class="token punctuation">.</span>render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span>inner<span class="token punctuation">,</span> graph<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> initialScale <span class="token operator">=</span> <span class="token number">0.80</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> transXY <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>svg<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span> <span class="token operator">-</span> graph<span class="token punctuation">.</span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width <span class="token operator">*</span> initialScale<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  zoom<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>transXY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>initialScale<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>svg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这就是如何在 React 项目中使用 dagre-d3 来绘制有向图。当然，其实其他还没有 React-ready 的库也同样可以自己摸索一下，基本上都可以很愉快在 React 中使用哦。</p>
</article></section><footer class="footer">
  Copyright ©2014-2017 <a href="http://minghe.me"> minghe.me</a> | Powered by <a href="https://github.com/metrue/Seal">Seal</a> on top of <a href="https://vuejs.org" target="_blank">Vue.js</a></footer></html>